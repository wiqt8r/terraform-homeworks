# Домашнее задание к занятию «Управляющие конструкции в коде Terraform»

### Задание 1

Проект инициализирован. На этом этапе прилегло зеркало яндекса, по terraform-mirror.yandexcloud.net и субдиректориям возвращалось 404. Пришлось скопировать провайдера из проекта 02.

Код выполнен, создана группа безопасности example_dynamic:

<img width="1149" height="646" alt="image" src="https://github.com/user-attachments/assets/77c5fdc7-1470-4828-b6f9-09f0400f3146" />


------

### Задание 2

ВМ созданы, код в гитхабе. БД созданы позже вебов.

<img width="1998" height="513" alt="image" src="https://github.com/user-attachments/assets/3f157257-620e-4c8d-866d-a1ce6ae0d20d" />

Считывание ssh-ключа настроено в locals.tf
```
locals {
  # формируем ключ
  ssh_pub_key = format("ubuntu:%s", trimspace(file(pathexpand("~/.ssh/yc_key.pub"))))

  # метадата для ВМ
  vms_metadata = {
    serial-port-enable = 1
    ssh-keys           = local.ssh_pub_key
  }
}
```

------

### Задание 3

Создана ВМ storage с тремя доп дисками

<img width="1549" height="551" alt="image" src="https://github.com/user-attachments/assets/63ddca6e-eaf5-4cc5-96d4-30d0e1105d0d" />

Код в гитхабе.


------

### Задание 4

Скриншот получившегося файла (полагаю, имелся в виду `hosts.ini`?):

<img width="1007" height="425" alt="image" src="https://github.com/user-attachments/assets/fa5d786a-2e6f-4526-b330-621c9f27c924" />



------

### Задание 5* (необязательное)
Сделал файл outputs.tf
```
output "vms_list" {
  description = "Все ВМ из count и for_each"
  value = concat(
    [
      for vm in yandex_compute_instance.web :
      {
        name = vm.name
        id   = vm.id
        fqdn = vm.fqdn
      }
    ],
    [
      for vm in values(yandex_compute_instance.db) :
      {
        name = vm.name
        id   = vm.id
        fqdn = vm.fqdn
      }
    ]
  )
}
```

Результат

<img width="1775" height="636" alt="image" src="https://github.com/user-attachments/assets/6449c245-d213-428e-a1e7-c941352307da" />



Код проекта здесь:
### https://github.com/wiqt8r/terraform-homeworks/tree/main/03/src ###
------
------

### Задание 6* (необязательное)
***не разобрался, когда-нибудь позже сделаю, наверно после прохождения блока по ансиблу***
1. Используя null_resource и local-exec, примените ansible-playbook к ВМ из ansible inventory-файла.
Готовый код возьмите из демонстрации к лекции [**demonstration2**](https://github.com/netology-code/ter-homeworks/tree/main/03/demo).
3. Модифицируйте файл-шаблон hosts.tftpl. Необходимо отредактировать переменную ```ansible_host="<внешний IP-address или внутренний IP-address если у ВМ отсутвует внешний адрес>```.

Для проверки работы уберите у ВМ внешние адреса(nat=false). Этот вариант используется при работе через bastion-сервер.
Для зачёта предоставьте код вместе с основной частью задания.

### Задание 7* (необязательное)
> Ваш код возвращает вам следущий набор данных: 
```
> local.vpc
{
  "network_id" = "enp7i560tb28nageq0cc"
  "subnet_ids" = [
    "e9b0le401619ngf4h68n",
    "e2lbar6u8b2ftd7f5hia",
    "b0ca48coorjjq93u36pl",
    "fl8ner8rjsio6rcpcf0h",
  ]
  "subnet_zones" = [
    "ru-central1-a",
    "ru-central1-b",
    "ru-central1-c",
    "ru-central1-d",
  ]
}
```
Выражение в terraform console, которое удалит из данной переменной 3 элемент из subnet_ids и subnet_zones:
```
> <некое выражение>
{
  "network_id" = "enp7i560tb28nageq0cc"
  "subnet_ids" = [
    "e9b0le401619ngf4h68n",
    "e2lbar6u8b2ftd7f5hia",
    "fl8ner8rjsio6rcpcf0h",
  ]
  "subnet_zones" = [
    "ru-central1-a",
    "ru-central1-b",
    "ru-central1-d",
  ]
}
```
### Задание 8* (необязательное)
В tpl-шаблоне:
```
[webservers]
%{~ for i in webservers ~}
${i["name"]} ansible_host=${i["network_interface"][0]["nat_ip_address"] platform_id=${i["platform_id "]}}
%{~ endfor ~}
```
есть две две ошибки:
- нет закрывающей скобки в `ansible_host` после `["nat_ip_address"]`
- лишний пробел в `["platform_id "]`

Надо так:
```
[webservers]
%{~ for i in webservers ~}
${i["name"]} ansible_host=${i["network_interface"][0]["nat_ip_address"]} platform_id=${i["platform_id"]}
%{~ endfor ~}
```

### Задание 9* (необязательное)
terraform выражения, которые сформируют списки:
>1. ["rc01","rc02","rc03","rc04",rc05","rc06",rc07","rc08","rc09","rc10....."rc99"] те список от "rc01" до "rc99"
```
[for i in range(1, 100) : format("rc%02d", i)]
```
>2. ["rc01","rc02","rc03","rc04",rc05","rc06","rc11","rc12","rc13","rc14",rc15","rc16","rc19"....."rc96"] те список от "rc01" до "rc96", пропуская все номера, заканчивающиеся на "0","7", "8", "9", за исключением "rc19"
```
[for i in range(1, 97) : format("rc%02d", i) if (i == 19 || !contains([0,7,8,9], i % 10))]
```



